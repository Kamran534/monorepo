<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Test - Web Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 24px;
            font-size: 14px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 24px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Database Setup Test</h1>
        <p class="subtitle">Web Version (sql.js + IndexedDB)</p>

        <div id="status"></div>

        <button id="testBtn" onclick="runTest()">Run Database Test</button>

        <div id="output"></div>
    </div>

    <script type="module">
        import initSqlJs from 'https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/sql-wasm.js';

        window.runTest = async function() {
            const output = document.getElementById('output');
            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('testBtn');

            output.textContent = '';
            statusDiv.innerHTML = '<span class="status loading">Testing...</span>';
            btn.disabled = true;

            function log(text) {
                output.textContent += text + '\n';
            }

            try {
                log('ğŸ” Database Setup Test (Web)\n');
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

                // Initialize sql.js
                log('â³ Loading SQL.js...');
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/${file}`
                });
                log('âœ… SQL.js loaded\n');

                // Try to load database from IndexedDB
                log('â³ Checking IndexedDB for existing database...');
                const savedDb = await loadDatabase();

                let db;
                if (savedDb) {
                    log('âœ… Found existing database in IndexedDB');
                    db = new SQL.Database(savedDb);
                    log(`   Size: ${(savedDb.length / 1024).toFixed(2)} KB\n`);
                } else {
                    log('âš ï¸  No database found in IndexedDB');
                    log('   (This is normal on first run)\n');
                    db = new SQL.Database();
                }

                // Test 1: Check migrations
                log('ğŸ“‹ Test 1: Applied Migrations');
                log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                try {
                    const migrations = db.exec('SELECT * FROM schema_migrations ORDER BY migration_id');
                    if (migrations.length > 0 && migrations[0].values.length > 0) {
                        log(`Found ${migrations[0].values.length} migrations:`);
                        migrations[0].values.forEach(row => {
                            log(`  âœ“ Version ${row[1]}: ${row[2]}`);
                        });
                    } else {
                        log('âš ï¸  No migrations applied yet');
                        log('   Run the web app to apply migrations');
                    }
                } catch (e) {
                    log('âš ï¸  schema_migrations table not found');
                    log('   Database needs to be initialized by running the app');
                }
                log('');

                // Test 2: Count tables and views
                log('ğŸ“Š Test 2: Database Objects');
                log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                try {
                    const result = db.exec(`
                        SELECT type, COUNT(*) as count
                        FROM sqlite_master
                        WHERE type IN ('table', 'view')
                        AND name NOT LIKE 'sqlite_%'
                        GROUP BY type
                    `);

                    if (result.length > 0) {
                        result[0].values.forEach(row => {
                            log(`  ${row[0]}s: ${row[1]}`);
                        });

                        // List tables
                        const tables = db.exec(`
                            SELECT name
                            FROM sqlite_master
                            WHERE type = 'table'
                            AND name NOT LIKE 'sqlite_%'
                            ORDER BY name
                        `);

                        if (tables.length > 0 && tables[0].values.length > 0) {
                            log(`\n  Tables (${tables[0].values.length}):`);
                            tables[0].values.forEach(row => log(`    â€¢ ${row[0]}`));
                        }

                        // List views
                        const views = db.exec(`
                            SELECT name
                            FROM sqlite_master
                            WHERE type = 'view'
                            ORDER BY name
                        `);

                        if (views.length > 0 && views[0].values.length > 0) {
                            log(`\n  Views (${views[0].values.length}):`);
                            views[0].values.forEach(row => log(`    â€¢ ${row[0]}`));
                        }
                    } else {
                        log('âš ï¸  No tables or views found');
                    }
                } catch (e) {
                    log('âš ï¸  Error querying database objects: ' + e.message);
                }
                log('');

                // Test 3: Check lookup data
                log('ğŸ”§ Test 3: Lookup Data');
                log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                const lookupTables = [
                    'roles',
                    'permissions',
                    'shift_statuses',
                    'order_types',
                    'order_statuses',
                    'payment_method_types',
                    'payment_statuses'
                ];

                lookupTables.forEach(table => {
                    try {
                        const result = db.exec(`SELECT COUNT(*) FROM ${table}`);
                        if (result.length > 0) {
                            log(`  ${table}: ${result[0].values[0][0]} records`);
                        }
                    } catch (e) {
                        log(`  ${table}: âš ï¸  Not found`);
                    }
                });
                log('');

                // Test 4: IndexedDB info
                log('ğŸ’¾ Test 4: IndexedDB Storage');
                log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                if (savedDb) {
                    log(`  Database size: ${(savedDb.length / 1024).toFixed(2)} KB`);
                    log(`  Storage: IndexedDB (payflow-sqlite)`);
                    log('  Status: âœ… Persisted');
                } else {
                    log('  Status: âš ï¸  Not yet persisted');
                    log('  Run the web app to create and persist database');
                }
                log('');

                // Summary
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                log('ğŸ“ SUMMARY');
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                if (savedDb) {
                    log('âœ… Database exists in IndexedDB');
                    log('âœ… Can be loaded and queried');
                    log('\nğŸ‰ Database setup is working!');
                } else {
                    log('âš ï¸  Database not initialized yet');
                    log('\nğŸ“Œ Next step: Run the web app to initialize');
                }

                statusDiv.innerHTML = '<span class="status success">Test Complete</span>';

            } catch (error) {
                log('\nâŒ Error: ' + error.message);
                log('\nStack trace:');
                log(error.stack);
                statusDiv.innerHTML = '<span class="status error">Test Failed</span>';
            } finally {
                btn.disabled = false;
            }
        };

        async function loadDatabase() {
            try {
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('payflow-sqlite', 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });

                return new Promise((resolve, reject) => {
                    const tx = db.transaction('sqlite-dbs', 'readonly');
                    const store = tx.objectStore('sqlite-dbs');
                    const request = store.get('payflow.db');
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result || null);
                });
            } catch (error) {
                return null;
            }
        }
    </script>
</body>
</html>
